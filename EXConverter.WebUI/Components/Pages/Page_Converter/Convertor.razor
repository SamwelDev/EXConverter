@page "/Individual"
@inject IJSRuntime JS
@inject IConService _service
@inject ILogger<Convertor> _logger
@rendermode InteractiveServer

<PageTitle>CONFILE | Pakia</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class=" rounded">
                <div class="card-body text-center">
                    <h5 class="text-primary  mb-3">Pakia faili yako ya Excel</h5>
                   
                    <div class="drop-zone border-2 border-dashed rounded p-4 mb-3">
                        <InputFile OnChange="HandleFile" id="fileInput" />

                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                        <p class="mb-2">
                            <small class="swahili-lab">(Buruta na pakia Excel faili hapa)</small>
                        </p>

                        @if (!string.IsNullOrEmpty(_fileName))
                        {
                            <p class="mt-2"><small class="swahili-lab">Faili iliyochaguliwa</small> @_fileName</p>
                        }

                        @if (IsLoading)
                        {
                            <div class="mt-3">
                                <div class="spinner-border text-success" role="status"></div>
                                <p class="mt-2 mb-0">
                                    <small class="swahili-lab">Ikibadilishwa faili yako ya Excel kuwa PDF. Tafadhali subiri..</small>
                                </p>
                            </div>
                        }
                    </div>

                    @if (_pdfBytes != null && !IsLoading)
                    {
                        <p class="text-success mb-2">
                            <small class="swahili-lab">Faili lako tayari limenadilishwa kwenda PDF, gusa kitufe chini kupakua</small>
                        </p>
                        <a href="@_pdfUrl" download="Converted.pdf" class="btn btn-outline-info small">
                            <i class="fas fa-download me-2"></i>
                            <small class="swahili-lab">Pakua PDF</small>
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row text-center mt-5">
        <div class="col-md-4 mb-4">
            <i class="bi-incognito fs-3 text-primary mb-2"></i>
            <h6 class="text-black">Jinsi Inavyofanya Kazi</h6>
            <p class="swahili-lab">
                Pakia faili lako la Excel (.xls/.xlsx), mfumo utalibadilisha kuwa PDF moja kwa moja. Faili linachakatwa haraka na salama.
            </p>
        </div>
        <div class="col-md-4 mb-4">
            <i class="bi-shield-check fs-3 text-success mb-2"></i>
            <h6 class="text-black">Usalama na Faragha</h6>
            <p class="swahili-lab">
                Faili zako zinalindwa kwa usimbaji fiche. sihifadhi data/taarifa zako baada ya mchakato kukamilika.
            </p>
        </div>
        <div class="col-md-4 mb-4">
            <i class="bi-display-fill  fs-3 text-info mb-2"></i>
            <h6 class="text-black">Inafanya Kazi Kwenye Vifaa Vyote</h6>
            <p class="swahili-lab">
                Tumia huduma hii kwenye Windows, Mac, Linux, Android au iOS. Hakuna programu ya ziada inayohitajika.
            </p>
        </div>
        <div class="col-md-4 mb-4">
            <i class="bi-star fs-3 text-warning mb-2"></i>
            <h6 class="text-black">Matokeo ya Ubora wa Juu</h6>
            <p class="swahili-lab">
                Faili zako zinabadilishwa kwa ubora wa juu kwa kutumia teknolojia ya kisasa ya PDF. Inasaidia fomati nyingi za Excel.
            </p>
        </div>
        <div class="col-md-4 mb-4">
            <i class="bi-lightning-fill fs-3 text-danger "></i>
            <h6 class="text-black">Haraka na Rahisi</h6>
            <p class="swahili-lab">
                Badilisha faili lako kwa hatua chache tu. Hakuna usajili, hakuna usumbufu pakia, subiri, pakua ni rahisi tu.
            </p>
        </div>
        <div class="col-md-4 mb-4">
            <i class="bi-globe-europe-africa-fill fs-3 text-primary mb-2"></i>
            <h6 class="text-black">Upatikanaji Popote</h6>
            <p class="swahili-lab">
                Tumia huduma hii kutoka mahali popote duniani. Faili zako zinapatikana kwa urahisi kupitia kifaa chako.
            </p>
        </div>
    </div>
</div>

@code {
    private byte[] _pdfBytes;
    private string _pdfUrl = string.Empty;
    private string _fileName = string.Empty;
    private ElementReference fileInput;
    private bool IsLoading = false;

    private async Task TriggerFileInput()
    {
        _logger.LogInformation("Try to access of file input");
        await JS.InvokeVoidAsync("uploadHelper.clickInput", fileInput);
    }


    private async Task HandleFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        _fileName = file.Name;
        await ConvertFile(file);
        _logger.LogInformation("Try to handle file so as can convert");
    }

    [JSInvokable]
    public async Task OnDropFile(string base64File, string fileName)
    {
        IsLoading = true;
        _fileName = fileName;
        StateHasChanged();

        try
        {
            byte[] fileBytes = Convert.FromBase64String(base64File);
            using var ms = new MemoryStream(fileBytes);

            _pdfBytes = _service.ConvertExcelToPdf(ms);
            _pdfUrl = $"data:application/pdf;base64,{Convert.ToBase64String(_pdfBytes)}";
        }
        catch (Exception ex)
        {
            _logger.LogError($" PDF conversion failed: {ex.Message}");

        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ConvertFile(IBrowserFile file)
    {
        IsLoading = true;
        _pdfBytes = null;
        _pdfUrl = string.Empty;
        StateHasChanged();

        try
        {
            using var ms = new MemoryStream();
            await file.OpenReadStream(maxAllowedSize: 10_000_000).CopyToAsync(ms);
            ms.Position = 0; 

            _pdfBytes = _service.ConvertExcelToPdf(ms);

            if (_pdfBytes != null && _pdfBytes.Length > 0)
            {
                _pdfUrl = $"data:application/pdf;base64,{Convert.ToBase64String(_pdfBytes)}";
            }
            else
            {
                _logger.LogWarning(" PDF generation returned empty result");
            }
        }
        catch (Exception ex)
        {
            _logger.LogError($" PDF conversion failed: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }


   
}
